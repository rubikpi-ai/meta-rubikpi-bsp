# Copyright (c) 2025 Qualcomm Innovation Center, Inc. All rights reserved.
# SPDX-License-Identifier: BSD-3-Clause-Clear

policy_module(qcom_cloudagent, 1.0)

type qcom_cloudagent_t;
type qcom_cloudagent_exec_t;
type qcom_cloudagent_usr_share_t;
type qcom_cloudagent_var_lib_t;

files_type(qcom_cloudagent_usr_share_t)
files_type(qcom_cloudagent_var_lib_t)

domain_type(qcom_cloudagent_t)

init_daemon_domain(qcom_cloudagent_t, qcom_cloudagent_exec_t)

#Connect to port
allow qcom_cloudagent_t self:tcp_socket { create_stream_socket_perms };
allow qcom_cloudagent_t self:unix_dgram_socket { create_socket_perms };
corenet_tcp_connect_all_unreserved_ports(qcom_cloudagent_t)
corenet_tcp_bind_generic_node(qcom_cloudagent_t)

#File permissions
allow qcom_cloudagent_t qcom_cloudagent_usr_share_t:dir rw_dir_perms;
allow qcom_cloudagent_t qcom_cloudagent_usr_share_t:file rw_file_perms;
allow qcom_cloudagent_t qcom_cloudagent_var_lib_t:dir rw_dir_perms;
allow qcom_cloudagent_t qcom_cloudagent_var_lib_t:file rw_file_perms;
search_var_lib(qcom_cloudagent_t)
miscfiles_read_generic_certs(qcom_cloudagent_t)

#for logging to journald
logging_send_syslog_msg(qcom_cloudagent_t)

# Network access
sysnet_read_config(qcom_cloudagent_t)
allow qcom_cloudagent_t self:capability net_admin;
allow qcom_cloudagent_t self:udp_socket { create_socket_perms };
files_read_etc_files(qcom_cloudagent_t)
corenet_tcp_connect_http_port(qcom_cloudagent_t)
allow qcom_cloudagent_t self:netlink_route_socket r_netlink_socket_perms;
systemd_read_resolved_runtime(qcom_cloudagent_t)
